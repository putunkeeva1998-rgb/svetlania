<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SVETLANIA</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Ruslan+Display&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #D4AF37; --bg: #fffaf0; --dark: #1a1a1a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: var(--dark); overflow-x: hidden; }
        
        .header { background: #fff; padding: 15px; text-align: center; border-bottom: 2px solid var(--gold); position: sticky; top: 0; z-index: 100; }
        .old-russian { font-family: 'Ruslan Display', cursive; color: var(--gold); font-size: 28px; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        
        .container { padding: 15px; padding-bottom: 120px; }
        
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: #fff; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; border: 1px solid rgba(212, 175, 55, 0.1); }
        .card img { width: 100%; aspect-ratio: 3/4; object-fit: cover; display: block; }
        .card-info { padding: 12px; text-align: center; }
        .card-price { color: var(--gold); font-weight: 800; }

        .fav-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #ccc; }
        .fav-btn.active { color: #e74c3c; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: var(--gold); font-weight: bold; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 14px; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { border: none; background: none; color: #bbb; display: flex; flex-direction: column; align-items: center; font-size: 9px; font-weight: bold; }
        .nav-item.active { color: var(--gold); }

        .cat-btn { padding: 10px 15px; border-radius: 20px; border: 1px solid var(--gold); background: #fff; color: var(--gold); margin-right: 5px; font-size: 12px; }
        .cat-btn.active { background: var(--gold); color: #fff; }

        /* –í–∞–∂–Ω–æ: –∑–∞–¥–∞–µ–º —á–µ—Ç–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –∫–∞—Ä—Ç—ã */
        #map { width: 100%; height: 250px; border-radius: 15px; margin-top: 10px; border: 1px solid var(--gold); background-color: #f0f0f0; position: relative; }

        .modal { position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; padding-bottom: 50px; }
        .close-btn { position: fixed; top: 20px; left: 20px; background: #fff; border-radius: 50%; width: 40px; height: 40px; border: 1px solid #eee; z-index: 2100; font-size: 20px; color: var(--gold); }
        .btn-main { width: 100%; padding: 16px; background: var(--gold); color: #fff; border: none; border-radius: 15px; font-weight: bold; margin-top: 15px; }
        .btn-main:disabled { background: #ccc; }
    </style>
</head>
<body>

<div id="app">
    <div class="header"><h1 class="old-russian">SVETLANIA</h1></div>

    <div class="container">
        <div v-if="activeTab === 'catalog'">
            <div style="display: flex; overflow-x: auto; padding-bottom: 15px;">
                <button v-for="cat in categories" @click="currentCategory = cat" :class="['cat-btn', currentCategory === cat ? 'active' : '']">{{cat}}</button>
            </div>
            <div class="products-grid">
                <div v-for="p in filteredProducts" :key="p.id" class="card" @click="openProduct(p)">
                    <button class="fav-btn" @click.stop="toggleFav(p)" :class="{active: isFav(p)}">‚ù§</button>
                    <img :src="p.image">
                    <div class="card-info">
                        <div style="font-size: 11px;">{{p.name}}</div>
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'favs'">
            <h2 class="old-russian" style="font-size: 20px;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
            <div v-if="favItems.length === 0" style="text-align: center; margin-top: 50px; color: #999;">–¢—É—Ç –ø–æ–∫–∞ –ø—É—Å—Ç–æ</div>
            <div v-else class="products-grid">
                <div v-for="p in favItems" :key="p.id" class="card" @click="openProduct(p)">
                    <button class="fav-btn active" @click.stop="toggleFav(p)">‚ù§</button>
                    <img :src="p.image">
                    <div class="card-info"><div>{{p.name}}</div><div class="card-price">{{p.price}} ‚ÇΩ</div></div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'">
            <h2 class="old-russian" style="font-size: 20px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
            <div v-if="cart.length === 0" style="text-align: center; margin-top: 50px; color: #999;">–ü—É—Å—Ç–æ</div>
            <div v-else>
                <div v-for="item in cart" :key="item.cartId" style="display: flex; gap: 10px; padding: 10px; border-bottom: 1px solid #eee;">
                    <img :src="item.image" style="width: 40px; height: 50px; object-fit: cover;">
                    <div style="flex: 1; font-size: 12px;"><b>{{item.name}}</b> ({{item.size}})<br>{{item.price}} ‚ÇΩ</div>
                    <button @click="removeFromCart(item.cartId)">‚úï</button>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 15px; margin-top: 15px;">
                    <div class="input-group"><label>–ò–ú–Ø</label><input class="input-field" v-model="form.firstName"></div>
                    <div class="input-group"><label>–¢–ï–õ–ï–§–û–ù</label><input class="input-field" v-model="form.phone" type="tel"></div>
                    
                    <label style="font-size: 12px; font-weight: bold;">–î–û–°–¢–ê–í–ö–ê</label>
                    <div style="display: flex; gap: 5px; margin: 10px 0;">
                        <button v-for="m in ['–°–î–≠–ö', '–ü–æ—á—Ç–∞']" @click="setDelivery(m)" :class="['cat-btn', deliveryMode === m ? 'active' : '']" style="flex: 1;">{{m}}</button>
                    </div>

                    <div v-show="deliveryMode">
                        <p style="font-size: 11px;">üìç <b>–ê–¥—Ä–µ—Å:</b> {{address || '–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É'}}</p>
                        <div id="map"></div>
                    </div>
                </div>
                <button class="btn-main" @click="sendOrder" :disabled="!isFormValid">–ó–ê–ö–ê–ó–ê–¢–¨: {{totalSum}} ‚ÇΩ</button>
            </div>
        </div>
    </div>

    <div v-if="selectedProduct" class="modal">
        <button class="close-btn" @click="selectedProduct = null">‚úï</button>
        <img :src="selectedProduct.image" style="width: 100%">
        <div style="padding: 20px;">
            <h2 class="old-russian">{{selectedProduct.name}}</h2>
            <div class="card-price">{{selectedProduct.price}} ‚ÇΩ</div>
            <div style="display: flex; margin-top: 15px;">
                <button v-for="s in selectedProduct.sizes" @click="tempSize = s" :class="['cat-btn', tempSize === s ? 'active' : '']" style="flex: 1;">{{s}}</button>
            </div>
            <button class="btn-main" @click="addToCart">–í –ö–û–†–ó–ò–ù–£</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button @click="activeTab = 'catalog'" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']">üè∞ –ö–ê–¢–ê–õ–û–ì</button>
        <button @click="activeTab = 'favs'" :class="['nav-item', activeTab === 'favs' ? 'active' : '']">‚ù§ –ò–ó–ë–†–ê–ù–ù–û–ï</button>
        <button @click="activeTab = 'cart'" :class="['nav-item', activeTab === 'cart' ? 'active' : '']">üõí –ö–û–†–ó–ò–ù–ê</button>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                activeTab: 'catalog',
                currentCategory: '—Ö–∞–ª–∞—Ç—ã',
                categories: ['—Ö–∞–ª–∞—Ç—ã', '—Å–æ—Ä–æ—á–∫–∏'],
                selectedProduct: null,
                tempSize: 'S',
                deliveryMode: '',
                address: '',
                map: null,
                marker: null,
                form: { firstName: '', phone: '' },
                products: [
                    { id: 1, category: '—Ö–∞–ª–∞—Ç—ã', name: '–•–∞–ª–∞—Ç "–ë–µ–ª–æ–µ –û–±–ª–∞–∫–æ"', price: 4500, image: '111white.jpg', sizes: ['S','M','L'], desc: '–®–µ–ª–∫.' },
                    { id: 2, category: '—Ö–∞–ª–∞—Ç—ã', name: '–•–∞–ª–∞—Ç "–ö—Ä–∞—Å–Ω–∞—è –ó–∞—Ä—è"', price: 5200, image: '111red.jpg', sizes: ['M','L'], desc: '–ê—Ç–ª–∞—Å.' },
                    { id: 3, category: '—Ö–∞–ª–∞—Ç—ã', name: '–•–∞–ª–∞—Ç "–ü–æ–ª–Ω–æ—á—å"', price: 4800, image: '111black.jpg', sizes: ['S','M','L'], desc: '–ß–µ—Ä–Ω—ã–π.' }
                ],
                cart: [],
                favorites: []
            }
        },
        computed: {
            filteredProducts() { return this.products.filter(p => p.category === this.currentCategory) },
            favItems() { return this.products.filter(p => this.favorites.includes(p.id)) },
            totalSum() { return this.cart.reduce((s, i) => s + i.price, 0) },
            isFormValid() { return this.form.firstName && this.form.phone && this.address }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            toggleFav(p) { this.vibrate(); const idx = this.favorites.indexOf(p.id); idx > -1 ? this.favorites.splice(idx, 1) : this.favorites.push(p.id); },
            isFav(p) { return this.favorites.includes(p.id); },
            openProduct(p) { this.vibrate(); this.selectedProduct = p; this.tempSize = p.sizes[0]; },
            addToCart() { this.vibrate(); this.cart.push({...this.selectedProduct, size: this.tempSize, cartId: Date.now()}); this.selectedProduct = null; },
            removeFromCart(id) { this.cart = this.cart.filter(i => i.cartId !== id); },
            
            setDelivery(m) { 
                this.vibrate(); 
                this.deliveryMode = m; 
                // –î–∞–µ–º Vue –≤—Ä–µ–º—è –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä #map
                setTimeout(() => { this.initMap(); }, 100);
            },

            initMap() {
                // –ï—Å–ª–∏ API –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                if (typeof DG !== 'undefined') {
                    if (this.map) { this.map.remove(); this.map = null; }
                    
                    this.map = DG.map('map', {
                        center: [55.75, 37.61],
                        zoom: 11,
                        zoomControl: false,
                        fullscreenControl: false
                    });

                    this.map.on('click', (e) => {
                        this.vibrate();
                        const {lat, lng} = e.latlng;
                        if (this.marker) {
                            this.marker.setLatLng([lat, lng]);
                        } else {
                            this.marker = DG.marker([lat, lng]).addTo(this.map);
                        }
                        
                        // –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ API 2–ì–ò–°
                        fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lng}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`)
                        .then(r => r.json())
                        .then(d => {
                            if (d.result && d.result.items.length > 0) {
                                this.address = d.result.items[0].address_name || d.result.items[0].full_name;
                            }
                        });
                    });
                } else {
                    console.error("2GIS SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
                }
            },

            sendOrder() {
                this.vibrate();
                const data = { user: this.form, cart: this.cart, total: this.totalSum, address: this.address };
                tg.sendData(JSON.stringify(data));
                tg.close();
            }
        },
        mounted() {
            tg.ready();
            tg.expand();
        }
    }).mount('#app');
</script>
</body>
</html>
