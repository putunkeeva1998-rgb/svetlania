<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SVETLANIA</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ruslan+Display&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #D4AF37; --bg: #ffffff; --dark: #1a1a1a; --gray: #8e8e93; --red: #e74c3c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: var(--dark); overflow-x: hidden; }
        
        .header { background: #fff; padding: 15px; text-align: center; border-bottom: 1px solid var(--gold); position: sticky; top: 0; z-index: 100; }
        .old-russian { font-family: 'Ruslan Display', cursive; color: var(--gold); font-size: 24px; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        
        .container { padding: 15px; padding-bottom: 110px; }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .categories-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .categories-nav::-webkit-scrollbar { display: none; }
        .cat-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--gold); background: #fff; color: var(--gold); font-size: 11px; white-space: nowrap; font-weight: bold; }
        .cat-btn.active { background: var(--gold); color: #fff; }

        /* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: #fff; border-radius: 15px; overflow: hidden; border: 1px solid #eee; position: relative; display: flex; flex-direction: column; }
        
        /* –°–ª–∞–π–¥–µ—Ä */
        .slider-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; overflow: hidden; background: #f9f9f9; }
        .slider-inner { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider-inner::-webkit-scrollbar { display: none; }
        .slider-inner img { width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; flex-shrink: 0; }
        
        .slider-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; pointer-events: none; }
        .dot { width: 5px; height: 5px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; width: 12px; border-radius: 10px; }

        .fav-abs { position: absolute; top: 8px; right: 8px; z-index: 5; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 28px; height: 28px; color: #ccc; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .fav-abs.active { color: var(--red); }

        .card-info { padding: 8px; text-align: center; flex-grow: 1; }
        .card-price { color: var(--gold); font-weight: 800; font-size: 14px; margin: 4px 0; }
        
        .size-picker-mini { display: flex; justify-content: center; gap: 3px; margin-bottom: 8px; }
        .size-s-btn { padding: 4px 6px; border: 1px solid #eee; border-radius: 5px; font-size: 9px; background: #f9f9f9; min-width: 25px; }
        .size-s-btn.active { border-color: var(--gold); background: var(--gold); color: #fff; }

        .add-btn { width: 100%; padding: 8px; background: var(--gold); color: #fff; border: none; border-radius: 10px; font-size: 10px; font-weight: bold; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { border: none; background: none; color: var(--gray); display: flex; flex-direction: column; align-items: center; font-size: 9px; gap: 4px; font-weight: bold; }
        .nav-item.active { color: var(--gold); }
        .nav-icon { font-size: 20px; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal { position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; padding-bottom: 40px; }
        .modal-close { position: fixed; top: 15px; left: 15px; width: 35px; height: 35px; border-radius: 50%; background: #fff; border: 1px solid #eee; z-index: 2100; display: flex; align-items: center; justify-content: center; }

        /* –ö–∞—Ä—Ç–∞ –∏ –≤–≤–æ–¥ */
        #map { width: 100%; height: 220px; border-radius: 12px; margin-top: 10px; border: 1px solid var(--gold); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 10px; color: var(--gold); font-weight: bold; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 14px; }
        .error-msg { color: var(--red); font-size: 10px; margin-top: 5px; font-weight: bold; }
        .btn-main { width: 100%; padding: 16px; background: var(--gold); color: #fff; border: none; border-radius: 15px; font-weight: bold; margin-top: 15px; }
        .btn-main:disabled { background: #eee; color: #aaa; }
    </style>
</head>
<body>

<div id="app">
    <div class="header"><h1 class="old-russian">SVETLANIA</h1></div>

    <div class="container">
        <div v-if="activeTab === 'catalog'">
            <div class="categories-nav">
                <button v-for="cat in categories" @click="currentCategory = cat; vibrate()" :class="['cat-btn', currentCategory === cat ? 'active' : '']">{{cat.toUpperCase()}}</button>
            </div>
            
            <div class="products-grid">
                <div v-for="p in filteredProducts" :key="p.id" class="card">
                    <button class="fav-abs" @click.stop="toggleFav(p)" :class="{active: isFav(p)}">‚ù§</button>
                    
                    <div class="slider-wrapper">
                        <div class="slider-inner" @scroll="e => handleSliderScroll(e, p)">
                            <img v-for="img in p.images" :src="img" @click="openProduct(p)">
                        </div>
                        <div class="slider-dots">
                            <div v-for="(img, idx) in p.images" :class="['dot', p.activeIdx === idx ? 'active' : '']"></div>
                        </div>
                    </div>

                    <div class="card-info">
                        <div style="font-size: 11px; font-weight: bold; height: 28px; overflow: hidden;">{{p.name}}</div>
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                        <div class="size-picker-mini">
                            <button v-for="s in p.sizes" @click="p.selectedSize = s; vibrate()" :class="['size-s-btn', p.selectedSize === s ? 'active' : '']">{{s}}</button>
                        </div>
                        <button class="add-btn" @click="addToCart(p)">–î–û–ë–ê–í–ò–¢–¨</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'favs'">
            <h2 class="old-russian" style="font-size: 18px; margin-bottom: 15px;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
            <div v-if="favItems.length === 0" style="text-align: center; margin-top: 50px; color: var(--gray);">–í–∞—à–µ —Å–µ—Ä–¥—Ü–µ –ø–æ–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ...</div>
            <div class="products-grid">
                <div v-for="p in favItems" :key="p.id" class="card">
                    <button class="fav-abs active" @click.stop="toggleFav(p)">‚ù§</button>
                    <img :src="p.images[0]" @click="openProduct(p)">
                    <div class="card-info">
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                        <button class="add-btn" @click="addToCart(p)">–î–û–ë–ê–í–ò–¢–¨</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'">
            <h2 class="old-russian" style="font-size: 18px; margin-bottom: 15px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
            <div v-if="cart.length === 0" style="text-align: center; margin-top: 50px; color: var(--gray);">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            <div v-else>
                <div v-for="item in cart" :key="item.cartId" style="display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center;">
                    <img :src="item.image" style="width: 45px; height: 60px; object-fit: cover; border-radius: 8px;">
                    <div style="flex: 1; font-size: 12px;"><b>{{item.name}}</b> ({{item.size}})<br><span style="color:var(--gold);">{{item.price}} ‚ÇΩ</span></div>
                    <button @click="removeFromCart(item.cartId)" style="border:none; background:none; color:#ccc; font-size:18px;">‚úï</button>
                </div>

                <div style="margin-top: 20px;">
                    <div class="input-group"><label>–ò–ú–Ø –ò –§–ê–ú–ò–õ–ò–Ø</label><input class="input-field" v-model="form.name" placeholder="–°–≤–µ—Ç–ª–∞–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞"></div>
                    <div class="input-group">
                        <label>–¢–ï–õ–ï–§–û–ù</label>
                        <input class="input-field" v-model="form.phone" type="tel" placeholder="+7...">
                        <div v-if="phoneErrorMsg" class="error-msg">{{phoneErrorMsg}}</div>
                    </div>

                    <label style="font-size: 10px; font-weight: bold; color: var(--gold);">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</label>
                    <div style="display: flex; gap: 5px; margin: 10px 0;">
                        <button v-for="d in ['5post', '–°–î–≠–ö', '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏']" @click="deliveryMode = d; vibrate(); initMap()" :class="['cat-btn', deliveryMode === d ? 'active' : '']" style="flex:1;">{{d}}</button>
                    </div>
                    <div v-show="deliveryMode">
                        <p style="font-size: 11px;">üìç <b>–ê–¥—Ä–µ—Å:</b> {{address || '–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É'}}</p>
                        <div id="map"></div>
                    </div>
                </div>
                <button class="btn-main" @click="sendOrder" :disabled="!isFormValid">–ó–ê–ö–ê–ó–ê–¢–¨: {{totalSum}} ‚ÇΩ</button>
            </div>
        </div>

        <div v-if="activeTab === 'profile'">
            <div style="text-align: center; padding: 30px 0;">
                <img :src="user.photo || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover;">
                <h2 style="margin: 15px 0 5px;">{{user.first_name}} {{user.last_name}}</h2>
                <button class="cat-btn" @click="tg.openTelegramLink('https://t.me/putunkeeva')">–ù–ê–ü–ò–°–ê–¢–¨ –í –ü–û–î–î–ï–†–ñ–ö–£</button>
            </div>
            <h3 class="old-russian" style="font-size: 16px; margin-top: 20px;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
            <div v-for="order in orderHistory" :key="order.id" style="background:#f9f9f9; padding:12px; border-radius:12px; margin-bottom:8px; font-size:12px; border:1px solid #eee;">
                <b>–ó–∞–∫–∞–∑ #{{order.id}}</b><br><small>{{order.date}} ‚Äî {{order.total}} ‚ÇΩ</small>
            </div>
        </div>
    </div>

    <div v-if="selectedProduct" class="modal">
        <button class="modal-close" @click="selectedProduct = null">‚úï</button>
        <div class="slider-wrapper" style="aspect-ratio: 1/1.3;">
             <div class="slider-inner" @scroll="e => handleSliderScroll(e, selectedProduct)">
                <img v-for="img in selectedProduct.images" :src="img">
            </div>
            <div class="slider-dots">
                <div v-for="(img, idx) in selectedProduct.images" :class="['dot', selectedProduct.activeIdx === idx ? 'active' : '']"></div>
            </div>
        </div>
        <div style="padding: 20px;">
            <h2 class="old-russian" style="margin:0;">{{selectedProduct.name}}</h2>
            <div class="card-price" style="font-size: 24px;">{{selectedProduct.price}} ‚ÇΩ</div>
            <p style="font-size: 14px; color: #666; line-height: 1.6; margin: 15px 0;">{{selectedProduct.desc}}</p>
            <div class="size-picker-mini" style="justify-content: flex-start; gap: 10px; margin-bottom: 25px;">
                <button v-for="s in selectedProduct.sizes" @click="selectedProduct.selectedSize = s; vibrate()" :class="['size-s-btn', selectedProduct.selectedSize === s ? 'active' : '']" style="padding: 10px 20px; font-size: 14px;">{{s}}</button>
            </div>
            <button class="btn-main" @click="addToCart(selectedProduct)">–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button @click="activeTab = 'catalog'; vibrate()" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']"><span class="nav-icon">‚óã</span>–ö–ê–¢–ê–õ–û–ì</button>
        <button @click="activeTab = 'favs'; vibrate()" :class="['nav-item', activeTab === 'favs' ? 'active' : '']"><span class="nav-icon">‚ô°</span>–ò–ó–ë–†–ê–ù–ù–û–ï</button>
        <button @click="activeTab = 'cart'; vibrate()" :class="['nav-item', activeTab === 'cart' ? 'active' : '']"><span class="nav-icon">‚ñ°</span>–ö–û–†–ó–ò–ù–ê</button>
        <button @click="activeTab = 'profile'; vibrate()" :class="['nav-item', activeTab === 'profile' ? 'active' : '']"><span class="nav-icon">‚ñ≥</span>–ü–†–û–§–ò–õ–¨</button>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                activeTab: 'catalog',
                currentCategory: '—Ö–∞–ª–∞—Ç—ã',
                categories: ['—Ö–∞–ª–∞—Ç—ã', '—Å–æ—Ä–æ—á–∫–∏'],
                selectedProduct: null,
                deliveryMode: '',
                address: '',
                map: null,
                marker: null,
                user: { first_name: '–ì–æ—Å—Ç—å', last_name: '', photo: '' },
                form: { name: '', phone: '' },
                products: [
                    { id: 1, category: '—Ö–∞–ª–∞—Ç—ã', name: '–•–∞–ª–∞—Ç "–ë–µ–ª–æ–µ –û–±–ª–∞–∫–æ"', price: 4500, images: ['111white.jpg'], sizes: ['S','M','L'], desc: '–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π —à–µ–ª–∫ –¥–ª—è –¥–æ–º–∞.', activeIdx: 0, selectedSize: 'S' },
                    { id: 2, category: '—Ö–∞–ª–∞—Ç—ã', name: '–•–∞–ª–∞—Ç "–ö—Ä–∞—Å–Ω–∞—è –ó–∞—Ä—è"', price: 5200, images: ['111red.jpg'], sizes: ['M','L'], desc: '–Ø—Ä–∫–∏–π –∞—Ç–ª–∞—Å —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã.', activeIdx: 0, selectedSize: 'M' },
                    { id: 3, category: '—Ö–∞–ª–∞—Ç—ã', name: '–•–∞–ª–∞—Ç "–ü–æ–ª–Ω–æ—á—å"', price: 4800, images: ['111black.jpg'], sizes: ['S','M','L'], desc: '–ö–ª–∞—Å—Å–∏–∫–∞ —á–µ—Ä–Ω–æ–≥–æ —à–µ–ª–∫–∞.', activeIdx: 0, selectedSize: 'S' }
                ],
                cart: JSON.parse(localStorage.getItem('svetlania_cart') || '[]'),
                favorites: JSON.parse(localStorage.getItem('svetlania_favs') || '[]'),
                orderHistory: JSON.parse(localStorage.getItem('svetlania_history') || '[]')
            }
        },
        computed: {
            filteredProducts() { return this.products.filter(p => p.category === this.currentCategory) },
            favItems() { return this.products.filter(p => this.favorites.includes(p.id)) },
            totalSum() { return this.cart.reduce((s, i) => s + i.price, 0) },
            phoneErrorMsg() {
                const p = this.form.phone.replace(/\D/g, '');
                if (!this.form.phone) return null;
                if (/[a-zA-Z–∞-—è–ê-–Ø]/.test(this.form.phone)) return "–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã!";
                if (p.length < 11) return "–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –Ω–æ–º–µ—Ä";
                if (['000000', '111111', '999999', '123456', '888888'].some(c => p.includes(c))) return "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä";
                return null;
            },
            isFormValid() {
                return this.form.name.length > 2 && !this.phoneErrorMsg && this.form.phone.length > 10 && this.address && this.cart.length > 0;
            }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            handleSliderScroll(e, p) { p.activeIdx = Math.round(e.target.scrollLeft / e.target.offsetWidth); },
            toggleFav(p) {
                this.vibrate();
                const idx = this.favorites.indexOf(p.id);
                idx > -1 ? this.favorites.splice(idx, 1) : this.favorites.push(p.id);
                localStorage.setItem('svetlania_favs', JSON.stringify(this.favorites));
            },
            isFav(p) { return this.favorites.includes(p.id); },
            openProduct(p) { this.vibrate(); this.selectedProduct = p; },
            addToCart(p) {
                this.vibrate();
                this.cart.push({ cartId: Date.now(), name: p.name, price: p.price, size: p.selectedSize, image: p.images[0] });
                localStorage.setItem('svetlania_cart', JSON.stringify(this.cart));
                this.selectedProduct = null;
            },
            removeFromCart(id) { 
                this.cart = this.cart.filter(i => i.cartId !== id);
                localStorage.setItem('svetlania_cart', JSON.stringify(this.cart));
            },
            initMap() {
                setTimeout(() => {
                    if (this.map) { this.map.remove(); this.map = null; }
                    this.map = DG.map('map', { center: [55.75, 37.61], zoom: 11, zoomControl: false });
                    this.map.on('click', (e) => {
                        this.vibrate();
                        const {lat, lng} = e.latlng;
                        if (this.marker) this.marker.setLatLng([lat, lng]);
                        else this.marker = DG.marker([lat, lng]).addTo(this.map);
                        
                        fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lng}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`)
                        .then(r => r.json()).then(d => {
                            if (d.result?.items?.length > 0) {
                                this.address = d.result.items[0].address_name || d.result.items[0].full_name;
                            }
                        });
                    });
                }, 100);
            },
            sendOrder() {
                this.vibrate();
                const orderId = `${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(10000 + Math.random() * 90000)}`;
                const orderData = { id: orderId, user: this.form, cart: this.cart, total: this.totalSum, delivery: this.deliveryMode, address: this.address };

                this.orderHistory.unshift({ id: orderId, date: new Date().toLocaleDateString(), total: this.totalSum });
                localStorage.setItem('svetlania_history', JSON.stringify(this.orderHistory));

                tg.sendData(JSON.stringify(orderData));
                localStorage.removeItem('svetlania_cart'); // –£–¥–∞–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞
                tg.close();
            }
        },
        mounted() {
            tg.ready(); tg.expand();
            if (tg.initDataUnsafe?.user) {
                const u = tg.initDataUnsafe.user;
                this.user = { first_name: u.first_name || '', last_name: u.last_name || '', photo: u.photo_url || '' };
                this.form.name = (this.user.first_name + ' ' + this.user.last_name).trim();
            }
        }
    }).mount('#app');
</script>
</body>
</html>
